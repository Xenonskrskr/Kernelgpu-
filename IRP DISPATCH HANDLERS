// Read handler
NTSTATUS GpuRead(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    PIO_STACK_LOCATION irpStack = NULL;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    irpStack = IoGetCurrentIrpStackLocation(Irp);
    if (!irpStack) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_VERBOSE, "Read request received");
    
    // TODO: Implement actual GPU memory read operation
    // This would read from GPU device memory
    
    Irp->IoStatus.Status = STATUS_SUCCESS;
    Irp->IoStatus.Information = 0;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    
    return STATUS_SUCCESS;
}

// Write handler
NTSTATUS GpuWrite(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    PIO_STACK_LOCATION irpStack = NULL;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    irpStack = IoGetCurrentIrpStackLocation(Irp);
    if (!irpStack) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_VERBOSE, "Write request received");
    
    // TODO: Implement actual GPU memory write operation
    // This would write to GPU device memory
    
    Irp->IoStatus.Status = STATUS_SUCCESS;
    Irp->IoStatus.Information = 0;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    
    return STATUS_SUCCESS;
}

// Device control (IOCTL) handler
NTSTATUS GpuDeviceControl(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    PIO_STACK_LOCATION irpStack = NULL;
    ULONG controlCode = 0;  // ✅ FIXED: Now will read the control code properly
    PVOID inputBuffer = NULL;
    PVOID outputBuffer = NULL;
    ULONG inputLength = 0;
    ULONG outputLength = 0;
    NTSTATUS status = STATUS_SUCCESS;
    ULONG_PTR information = 0;
    
    if (!DeviceObject || !Irp) {
        status = STATUS_INVALID_PARAMETER;
        goto cleanup;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        status = STATUS_INVALID_PARAMETER;
        goto cleanup;
    }
    
    irpStack = IoGetCurrentIrpStackLocation(Irp);
    if (!irpStack) {
        status = STATUS_INVALID_PARAMETER;
        goto cleanup;
    }
    
    // ✅ FIXED: Read the correct field for control code (was reading InputBufferLength)
    controlCode = irpStack->Parameters.DeviceIoControl.IoControlCode;
    inputBuffer = Irp->AssociatedIrp.SystemBuffer;
    outputBuffer = Irp->AssociatedIrp.SystemBuffer;
    inputLength = irpStack->Parameters.DeviceIoControl.InputBufferLength;
    outputLength = irpStack->Parameters.DeviceIoControl.OutputBufferLength;
    
    GPU_LOG(DEBUG_VERBOSE, "Device control request: 0x%08X", controlCode);
    
    if (deviceExtension->DeviceRemovalPending) {
        status = STATUS_DELETE_PENDING;
        goto cleanup;
    }
    
    switch (controlCode) {
        case IOCTL_GPU_GET_INFO:
            if (!outputBuffer || outputLength < sizeof(GPU_INFO)) {
                status = STATUS_BUFFER_TOO_SMALL;
            } else {
                RtlCopyMemory(outputBuffer, &deviceExtension->GpuInfo, sizeof(GPU_INFO));
                information = sizeof(GPU_INFO);
                status = STATUS_SUCCESS;
                GPU_LOG_SIMPLE(DEBUG_INFO, "GPU info retrieved successfully");
            }
            break;
            
        case IOCTL_GPU_GET_DRIVER_VERSION:
            if (!outputBuffer || outputLength < sizeof(GPU_DRIVER_VERSION)) {
                status = STATUS_BUFFER_TOO_SMALL;
            } else {
                PGPU_DRIVER_VERSION driverVersion = (PGPU_DRIVER_VERSION)outputBuffer;
                
                status = RtlStringCbCopyA((PCHAR)driverVersion->Version, 
                                         sizeof(driverVersion->Version), 
                                         DRIVER_VERSION);
                if (!NT_SUCCESS(status)) {
                    goto cleanup;
                }
                
                status = RtlStringCbCopyA((PCHAR)driverVersion->Date, 
                                         sizeof(driverVersion->Date), 
                                         DRIVER_DATE);
                if (!NT_SUCCESS(status)) {
                    goto cleanup;
                }
                
                status = RtlStringCbCopyA((PCHAR)driverVersion->Vendor, 
                                         sizeof(driverVersion->Vendor), 
                                         DRIVER_VENDOR);
                if (NT_SUCCESS(status)) {
                    information = sizeof(GPU_DRIVER_VERSION);
                    GPU_LOG_SIMPLE(DEBUG_INFO, "Driver version retrieved successfully");
                }
            }
            break;
            
        case IOCTL_GPU_QUERY_PERFORMANCE:
            if (!outputBuffer || outputLength < sizeof(GPU_PERFORMANCE_DATA)) {
                status = STATUS_BUFFER_TOO_SMALL;
            } else {
                status = GetPerformanceData(deviceExtension, (PGPU_PERFORMANCE_DATA)outputBuffer);
                if (NT_SUCCESS(status)) {
                    information = sizeof(GPU_PERFORMANCE_DATA);
                    GPU_LOG_SIMPLE(DEBUG_INFO, "Performance data retrieved successfully");
                }
            }
            break;
            
        case IOCTL_GPU_GET_MEMORY_INFO:
            if (!outputBuffer || outputLength < sizeof(GPU_MEMORY_INFO)) {
                status = STATUS_BUFFER_TOO_SMALL;
            } else {
                status = GetGpuMemoryInfo(deviceExtension, (PGPU_MEMORY_INFO)outputBuffer);
                if (NT_SUCCESS(status)) {
                    information = sizeof(GPU_MEMORY_INFO);
                    GPU_LOG_SIMPLE(DEBUG_INFO, "Memory info retrieved successfully");
                }
            }
            break;
            
        default:
            GPU_LOG(DEBUG_WARNING, "Unknown IOCTL code: 0x%08X", controlCode);
            status = STATUS_NOT_SUPPORTED;
            break;
    }
    
cleanup:
    Irp->IoStatus.Status = status;
    Irp->IoStatus.Information = information;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    
    return status;
}

// Cleanup handler
NTSTATUS GpuCleanup(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_VERBOSE, "Cleanup request received");
    
    Irp->IoStatus.Status = STATUS_SUCCESS;
    Irp->IoStatus.Information = 0;
    IoCompleteRequest(Irp, IO_NO_INCREMENT);
    
    return STATUS_SUCCESS;
}

// Power handler
NTSTATUS GpuPower(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    PIO_STACK_LOCATION irpStack = NULL;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    irpStack = IoGetCurrentIrpStackLocation(Irp);
    if (!irpStack) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG(DEBUG_VERBOSE, "Power IRP received: %d", irpStack->MinorFunction);
    
    // Pass power IRPs down the stack
    IoCopyCurrentIrpStackLocationToNext(Irp);
    return IoCallDriver(deviceExtension->NextLowerDriver, Irp);
}

// System control handler
NTSTATUS GpuSystemControl(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_VERBOSE, "System control IRP received");
    
    // Pass system control IRPs down the stack
    IoCopyCurrentIrpStackLocationToNext(Irp);
    return IoCallDriver(deviceExtension->NextLowerDriver, Irp);
}

// PnP handler
NTSTATUS GpuPnP(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    PIO_STACK_LOCATION irpStack = NULL;
    NTSTATUS status = STATUS_SUCCESS;
    
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    irpStack = IoGetCurrentIrpStackLocation(Irp);
    if (!irpStack) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG(DEBUG_INFO, "PnP IRP received: %d", irpStack->MinorFunction);
    
    switch (irpStack->MinorFunction) {
        case IRP_MN_START_DEVICE:
            status = GpuStartDevice(DeviceObject, Irp);
            break;
            
        case IRP_MN_STOP_DEVICE:
            status = GpuStopDevice(DeviceObject, Irp);
            break;
            
        case IRP_MN_REMOVE_DEVICE:
            status = GpuRemoveDevice(DeviceObject, Irp);
            break;
            
        default:
            IoCopyCurrentIrpStackLocationToNext(Irp);
            return IoCallDriver(deviceExtension->NextLowerDriver, Irp);
    }
    
    if (!NT_SUCCESS(status)) {
        Irp->IoStatus.Status = status;
        IoCompleteRequest(Irp, IO_NO_INCREMENT);
    }
    
    return status;
}
