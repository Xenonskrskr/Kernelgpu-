// GpuStartDevice - Initialize GPU hardware
NTSTATUS GpuStartDevice(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    NTSTATUS status = STATUS_SUCCESS;
    
    // ✅ FIXED: Added null pointer checks
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Starting GPU device");
    
    // Read PCI configuration
    status = GetPciResources(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to get PCI resources");
        goto cleanup;
    }
    
    // Enable the PCI device
    status = EnablePciDevice(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to enable PCI device");
        goto cleanup;
    }
    
    // Map GPU registers to kernel virtual address space
    status = MapGpuRegisters(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to map GPU registers");
        DisablePciDevice(deviceExtension);  // ✅ FIXED: Added rollback
        goto cleanup;
    }
    
    // Initialize memory manager
    status = InitializeMemoryManager(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to initialize memory manager");
        UnmapGpuRegisters(deviceExtension);
        DisablePciDevice(deviceExtension);
        goto cleanup;
    }
    
    // Initialize GPU hardware
    status = InitializeGpu(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to initialize GPU");
        CleanupMemoryManager(deviceExtension);
        UnmapGpuRegisters(deviceExtension);
        DisablePciDevice(deviceExtension);
        goto cleanup;
    }
    
    // Initialize command processor
    status = InitializeCommandProcessor(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to initialize command processor");
        CleanupGpu(deviceExtension);
        CleanupMemoryManager(deviceExtension);
        UnmapGpuRegisters(deviceExtension);
        DisablePciDevice(deviceExtension);
        goto cleanup;
    }
    
    // Initialize interrupt handling
    status = InitializeInterrupts(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_ERROR, "Failed to initialize interrupts");
        CleanupCommandProcessor(deviceExtension);
        CleanupGpu(deviceExtension);
        CleanupMemoryManager(deviceExtension);
        UnmapGpuRegisters(deviceExtension);
        DisablePciDevice(deviceExtension);
        goto cleanup;
    }
    
    // Start performance monitoring
    status = StartWatchdogTimer(deviceExtension);
    if (!NT_SUCCESS(status)) {
        GPU_LOG_SIMPLE(DEBUG_WARNING, "Failed to start watchdog timer (non-critical)");
        // Don't fail if watchdog fails - it's not critical
        status = STATUS_SUCCESS;
    }
    
    deviceExtension->GpuInitialized = TRUE;
    GPU_LOG_SIMPLE(DEBUG_INFO, "GPU device started successfully");
    
    return STATUS_SUCCESS;
    
cleanup:
    GPU_LOG(DEBUG_ERROR, "GPU start failed with status: 0x%08X", status);
    return status;
}

// GpuStopDevice - Disable GPU and clean up
NTSTATUS GpuStopDevice(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    
    // ✅ FIXED: Added null pointer checks
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    if (!deviceExtension->GpuInitialized) {
        return STATUS_SUCCESS;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Stopping GPU device");
    
    // Stop watchdog timer
    StopWatchdogTimer(deviceExtension);
    
    // Power down GPU
    SetGpuPowerState(deviceExtension, GPU_POWER_STATE_D3);
    
    // Disable interrupts
    DisableInterrupts(deviceExtension);
    
    // Stop command processor
    StopCommandProcessor(deviceExtension);
    
    // Cleanup resources in reverse order
    CleanupGpu(deviceExtension);
    CleanupMemoryManager(deviceExtension);
    UnmapGpuRegisters(deviceExtension);
    DisablePciDevice(deviceExtension);
    
    deviceExtension->GpuInitialized = FALSE;
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "GPU device stopped successfully");
    
    return STATUS_SUCCESS;
}

// GpuRemoveDevice - Handle device removal
NTSTATUS GpuRemoveDevice(IN PDEVICE_OBJECT DeviceObject, IN PIRP Irp)
{
    PDEVICE_EXTENSION deviceExtension = NULL;
    NTSTATUS status = STATUS_SUCCESS;
    
    // ✅ FIXED: Added null pointer checks
    if (!DeviceObject || !Irp) {
        return STATUS_INVALID_PARAMETER;
    }
    
    deviceExtension = (PDEVICE_EXTENSION)DeviceObject->DeviceExtension;
    if (!deviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Removing GPU device");
    
    // Set removal pending flag to reject new requests
    deviceExtension->DeviceRemovalPending = TRUE;
    
    // Wait for pending operations to complete
    ExWaitForRundownProtectionRelease(&deviceExtension->MemoryRundown);
    
    // Stop device first
    if (deviceExtension->GpuInitialized) {
        GpuStopDevice(DeviceObject, Irp);
    }
    
    // Complete removal
    IoDeleteSymbolicLink(&deviceExtension->DeviceSymbolicLink);
    IoDeleteDevice(DeviceObject);
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "GPU device removed successfully");
    
    return STATUS_SUCCESS;
}

// ✅ NEW: Helper function to handle PCI device disabling
NTSTATUS DisablePciDevice(IN PDEVICE_EXTENSION DeviceExtension)
{
    if (!DeviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Disabling PCI device");
    
    // Set PCI device to D3 (power off) state
    // Implementation depends on your specific PCI configuration
    
    return STATUS_SUCCESS;
}

// ✅ NEW: Helper function to stop command processor
NTSTATUS StopCommandProcessor(IN PDEVICE_EXTENSION DeviceExtension)
{
    if (!DeviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Stopping command processor");
    
    // Send stop command to GPU
    // Wait for pending commands to complete
    // Flush any remaining commands
    
    return STATUS_SUCCESS;
}

// ✅ NEW: Helper function to disable interrupts
NTSTATUS DisableInterrupts(IN PDEVICE_EXTENSION DeviceExtension)
{
    if (!DeviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG_SIMPLE(DEBUG_INFO, "Disabling GPU interrupts");
    
    // Disable all GPU interrupt sources
    // Unregister ISR if necessary
    
    return STATUS_SUCCESS;
}

// ✅ NEW: Helper function to set GPU power state
NTSTATUS SetGpuPowerState(IN PDEVICE_EXTENSION DeviceExtension, IN ULONG PowerState)
{
    if (!DeviceExtension) {
        return STATUS_INVALID_PARAMETER;
    }
    
    GPU_LOG(DEBUG_INFO, "Setting GPU power state to: %lu", PowerState);
    
    // Write power state configuration to GPU registers
    // Handle D0, D1, D2, D3 states appropriately
    
    return STATUS_SUCCESS;
}
